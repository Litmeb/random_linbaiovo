<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>茶话会随机生成 - Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 修改点 1：引入了 Noto Sans SC (思源黑体) 作为替补 -->
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Noto+Sans+SC:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* 修改点 2：将 Noto Sans SC 加入字体栈，并设为 sans-serif */
        body, button, div, h1, span {
            font-family: 'DotGothic16', 'Noto Sans SC', sans-serif !important;
        }

        body {
            background-color: #020202;
            color: #00ff41; /* 经典的复古绿 */
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* CRT 扫描线 */
        .scanlines {
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.2) 50%,
                rgba(0,0,0,0.2)
            );
            background-size: 100% 4px;
            position: fixed;
            pointer-events: none;
            top: 0; right: 0; bottom: 0; left: 0;
            z-index: 10;
        }

        /* 屏幕发光 */
        .crt-glow {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            background: radial-gradient(circle, rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.8) 100%);
            z-index: 20;
            box-shadow: inset 0 0 80px rgba(0, 255, 65, 0.15);
        }

        /* 故障动画 */
        @keyframes glitch-anim {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        .glitch-active {
            animation: glitch-anim 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite;
            text-shadow: 3px 0 #ff00c1, -3px 0 #00fff9;
            color: #fff;
        }

        /* 光标 */
        .cursor::after {
            content: '█';
            animation: blink 0.8s step-end infinite;
            margin-left: 5px;
            color: #00ff41;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* 按钮 */
        .cyber-btn {
            background: transparent;
            border: 2px solid #00ff41;
            color: #00ff41;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 2px;
            transition: all 0.2s ease;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);
            position: relative;
            overflow: hidden;
        }
        .cyber-btn:hover {
            background: #00ff41;
            color: #000;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.6);
        }
        .cyber-btn:active { transform: scale(0.96); }

        /* 滚动条 */
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #001100; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #004400; border: 1px solid #00ff41; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #00ff41; }

    </style>
</head>
<body class="selection:bg-green-500 selection:text-black">

    <div class="scanlines"></div>
    <div class="crt-glow"></div>

    <!-- 主容器 -->
    <div class="relative z-30 w-full max-w-4xl h-[95vh] md:h-[88vh] flex flex-col p-4 md:p-8 gap-4">
        
        <!-- 头部 -->
        <div class="flex justify-between items-end border-b-2 border-green-900 pb-2 mb-2 select-none">
            <div class="flex items-start gap-3">
                <div class="flex flex-col gap-2">
                    <div class="flex gap-2">
                        <button id="pause-btn" class="cyber-btn px-3 py-1 text-base md:text-lg rounded opacity-40 cursor-not-allowed" title="暂停" disabled>⏸</button>
                        <button id="restart-btn" class="cyber-btn px-3 py-1 text-base md:text-lg rounded" title="重开">⟲</button>
                    </div>
                    <div class="text-xs md:text-sm opacity-60">
                        STATUS: LISTENING...
                    </div>
                </div>
                <h1 class="text-3xl md:text-5xl font-bold tracking-tight text-green-500" style="text-shadow: 0 0 10px rgba(0,255,65,0.5);">
                    茶话会随机生成
                </h1>
            </div>
            <div class="text-right font-mono text-xs md:text-sm opacity-80">
                <div>当前最高: <span id="max-score-val">0</span></div>
                <div class="flex items-center gap-2">
                    历史最高: <span id="history-max-score-val">0</span>
                    <button type="button" id="clear-history-btn" class="cyber-btn px-2 py-0.5 text-xs rounded" title="清除历史最高">清除</button>
                </div>
            </div>
        </div>

        <!-- 显示区域 -->
        <div id="display-container" class="flex-1 border-2 border-green-900 bg-black/40 relative overflow-hidden flex flex-col items-center justify-center p-4 md:p-8 transition-all duration-300">
            
            <!-- 装饰噪音 -->
            <div class="absolute top-2 left-2 text-[10px] opacity-20 pointer-events-none whitespace-pre leading-3 select-none" id="bg-noise"></div>

            <!-- 文本核心 -->
            <div id="text-wrapper" class="w-full max-h-full custom-scroll overflow-y-auto flex flex-col items-center">
                <div id="main-text" class="cursor font-bold leading-relaxed text-center whitespace-pre-wrap break-words max-w-full my-auto" style="text-shadow: 0 0 8px rgba(0, 255, 65, 0.4);">
                    等待出题...
                </div>
                <div id="result-text" class="mt-4 text-base md:text-lg font-bold opacity-80 text-center"></div>
            </div>

        </div>

        <!-- 底部控制 -->
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mt-2">
            <div class="text-xs order-2 md:order-1 font-mono relative">
                <div class="opacity-80">
                    > CONNECTED TO SERVER <br>
                    > USER: <span id="user-name-display">???</span> <br>
                    > 正确: <span id="stat-correct">0</span> | 错误: <span id="stat-wrong">0</span> | 正确率: <span id="stat-rate">0%</span>
                </div>
                <div class="mt-2 flex items-center gap-2">
                    <span class="text-xl md:text-2xl font-bold" style="text-shadow: 0 0 8px rgba(0, 255, 65, 0.5);">SCORE: <span id="score-val">0</span></span>
                    <button type="button" id="score-help-btn" class="w-6 h-6 rounded-full border border-current text-sm flex items-center justify-center leading-none opacity-80 hover:opacity-100" title="计分规则">?</button>
                    <button type="button" id="leaderboard-btn" class="cyber-btn px-2 py-0.5 text-xs rounded opacity-100" title="排行榜">排行榜</button>
                </div>
                <div id="score-rules-tooltip" class="hidden absolute left-0 top-full mt-1 p-3 bg-black border-2 border-green-900 text-left text-xs max-w-xs z-50 rounded">
                    答题中每秒 -1 分；答完题的结算页面会暂停计时<br>答对 +10，答错 -10。
                </div>
            </div>
            <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto order-1 md:order-2">
                <button id="start-game-btn" class="cyber-btn px-12 py-4 text-xl md:text-2xl rounded w-full md:w-auto">
                    开始游戏
                </button>
                <button id="choice-linbai" class="cyber-btn px-8 py-3 text-lg md:text-xl rounded w-full md:w-auto hidden">
                    选项A
                </button>
                <button id="choice-nanoi" class="cyber-btn px-8 py-3 text-lg md:text-xl rounded w-full md:w-auto hidden">
                    选项B
                </button>
                <button id="next-question" class="cyber-btn px-8 py-3 text-lg md:text-xl rounded w-full md:w-auto hidden">
                    重新出题
                </button>
            </div>
        </div>

        <!-- 排行榜弹窗 -->
        <div id="leaderboard-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80" style="backdrop-filter: blur(4px);">
            <div class="bg-black border-2 border-green-900 rounded-lg max-w-md w-full max-h-[80vh] flex flex-col shadow-lg" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center p-4 border-b border-green-900">
                    <h2 class="text-xl font-bold text-green-500">排行榜</h2>
                    <button type="button" id="leaderboard-close" class="cyber-btn px-3 py-1 text-sm rounded">关闭</button>
                </div>
                <div id="leaderboard-list" class="flex-1 overflow-y-auto p-4 custom-scroll text-sm space-y-1">
                    <div class="opacity-60 text-center py-4">加载中...</div>
                </div>
                <div class="p-4 border-t border-green-900 space-y-3">
                    <label class="block text-sm opacity-80">你的名字（将显示在排行榜上）</label>
                    <input type="text" id="leaderboard-name-input" maxlength="20" placeholder="输入名字" class="w-full bg-black border-2 border-green-900 rounded px-3 py-2 text-green-500 placeholder-green-900 focus:outline-none focus:border-green-500" />
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <button type="button" id="leaderboard-submit" class="cyber-btn w-full py-2 rounded">上传历史最高分</button>
                        <button type="button" id="leaderboard-submit-current" class="cyber-btn w-full py-2 rounded opacity-90">上传当前最高分</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script>
        window.firestoreApi = { getLeaderboard: null, submitScore: null };
    </script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDrbk_wOJfNohIVEFSgAAA9D2XUdMFK5i0",
            authDomain: "who-post-this.firebaseapp.com",
            projectId: "who-post-this",
            storageBucket: "who-post-this.appspot.com",
            messagingSenderId: "549959020575",
            appId: "1:549959020575:web:9f78c757c79636d5b2252a"
        };

        let db = null;
        if (firebaseConfig.projectId && firebaseConfig.projectId !== "YOUR_PROJECT_ID") {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                window.firestoreApi.getLeaderboard = async function() {
                    const snap = await db.collection('leaderboard_teaparty')
                        .orderBy('score', 'desc')
                        .limit(200)
                        .get();
                    const list = snap.docs.map(d => {
                        const data = d.data();
                        const { deleteToken, ...rest } = data;
                        return { id: d.id, ...rest };
                    });
                    list.sort((a, b) => {
                        if (a.score !== b.score) return b.score - a.score;
                        const ra = Number(a.correctRate) || 0, rb = Number(b.correctRate) || 0;
                        if (ra !== rb) return rb - ra;
                        return (Number(b.correctCount) || 0) - (Number(a.correctCount) || 0);
                    });
                    return list.slice(0, 50);
                };
                window.firestoreApi.submitScore = async function(nickname, score, correctRate, correctCount) {
                    const sn = String(nickname).trim().slice(0, 20) || '匿名';
                    const sc = Number(score);
                    const cr = Number(correctRate);
                    const cc = Number(correctCount);
                    const dup = await db.collection('leaderboard_teaparty')
                        .where('score', '==', sc)
                        .where('correctRate', '==', cr)
                        .where('correctCount', '==', cc)
                        .limit(1)
                        .get();
                    if (!dup.empty) return { alreadyStored: true };
                    const deleteToken = Array.from({ length: 32 }, () => Math.random().toString(36)[2]).join('');
                    const ref = await db.collection('leaderboard_teaparty').add({
                        nickname: sn,
                        score: sc,
                        correctRate: cr,
                        correctCount: cc,
                        deleteToken: deleteToken,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return { alreadyStored: false, docId: ref.id, deleteToken: deleteToken };
                };
                window.firestoreApi.deleteEntry = async function(docId, deleteToken) {
                    const ref = db.collection('leaderboard_teaparty').doc(docId);
                    const snap = await ref.get();
                    if (!snap.exists) throw new Error('记录不存在');
                    if (snap.data().deleteToken !== deleteToken) throw new Error('无权删除该记录');
                    await ref.delete();
                };
            } catch (e) {
                console.warn('Firebase init failed', e);
            }
        }
    </script>
    <script>
        const mainText = document.getElementById('main-text');
        const resultText = document.getElementById('result-text');
        const textWrapper = document.getElementById('text-wrapper');
        const displayContainer = document.getElementById('display-container');
        const scoreVal = document.getElementById('score-val');
        const maxScoreVal = document.getElementById('max-score-val');
        const historyMaxScoreVal = document.getElementById('history-max-score-val');
        const bgNoise = document.getElementById('bg-noise');
        const choiceLinbai = document.getElementById('choice-linbai');
        const choiceNanoi = document.getElementById('choice-nanoi');
        const nextQuestion = document.getElementById('next-question');
        const pauseBtn = document.getElementById('pause-btn');
        const restartBtn = document.getElementById('restart-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const scoreHelpBtn = document.getElementById('score-help-btn');
        const scoreRulesTooltip = document.getElementById('score-rules-tooltip');
        const statCorrect = document.getElementById('stat-correct');
        const statWrong = document.getElementById('stat-wrong');
        const statRate = document.getElementById('stat-rate');
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const leaderboardModal = document.getElementById('leaderboard-modal');
        const leaderboardList = document.getElementById('leaderboard-list');
        const leaderboardClose = document.getElementById('leaderboard-close');
        const leaderboardSubmit = document.getElementById('leaderboard-submit');
        const leaderboardSubmitCurrent = document.getElementById('leaderboard-submit-current');
        const leaderboardNameInput = document.getElementById('leaderboard-name-input');
        const userNameDisplay = document.getElementById('user-name-display');

        let isTyping = false;
        let timeoutIds = [];
        let currentSource = null;
        let isAnswered = false;
        let posts = [];
        let postsReady = false;
        let score = 0;
        let maxScore = 0;
        let historyMaxScore = 0;
        let historyMaxCorrectCount = 0;
        let historyMaxWrongCount = 0;
        let scoreTimerId = null;
        let isPaused = false;
        let pausedResultHtml = "";
        let correctCount = 0;
        let wrongCount = 0;

        function updateStats() {
            statCorrect.textContent = String(correctCount);
            statWrong.textContent = String(wrongCount);
            const total = correctCount + wrongCount;
            const rate = total === 0 ? 0 : Math.round((correctCount / total) * 100);
            statRate.textContent = `${rate}%`;
        }

        function updateScore() {
            scoreVal.textContent = String(score);
            maxScoreVal.textContent = String(maxScore);
            if (score > maxScore) {
                maxScore = score;
                maxScoreVal.textContent = String(maxScore);
            }
            if (maxScore > historyMaxScore) {
                historyMaxScore = maxScore;
                historyMaxCorrectCount = correctCount;
                historyMaxWrongCount = wrongCount;
                historyMaxScoreVal.textContent = String(historyMaxScore);
                localStorage.setItem('historyMaxScore', String(historyMaxScore));
                localStorage.setItem('historyMaxCorrectCount', String(historyMaxCorrectCount));
                localStorage.setItem('historyMaxWrongCount', String(historyMaxWrongCount));
            }
        }

        // 噪音生成
        function updateNoise() {
            let noise = "";
            const chars = "01.. ";
            for(let i=0; i<100; i++) {
                noise += chars.charAt(Math.floor(Math.random() * chars.length)) + " ";
                if(i%10===0) noise += "\n";
            }
            bgNoise.innerText = noise;
        }
        setInterval(updateNoise, 1500);

        function clearTimeouts() {
            timeoutIds.forEach(id => clearTimeout(id));
            timeoutIds = [];
        }

        function stopScoreTimer() {
            if (scoreTimerId) {
                clearInterval(scoreTimerId);
                scoreTimerId = null;
            }
        }

        function startScoreTimer() {
            stopScoreTimer();
            scoreTimerId = setInterval(() => {
                if (isPaused || isAnswered || !postsReady) return;
                score -= 1;
                updateScore();
            }, 1000);
        }

        function setChoicesEnabled(enabled) {
            [choiceLinbai, choiceNanoi].forEach((btn) => {
                btn.disabled = !enabled;
                btn.classList.toggle('opacity-40', !enabled);
                btn.classList.toggle('cursor-not-allowed', !enabled);
            });
        }

        function showNextButton(show) {
            nextQuestion.classList.toggle('hidden', !show);
        }

        function getRandomItem(list) {
            return list[Math.floor(Math.random() * list.length)];
        }

        function pickQuestion() {
            const post = getRandomItem(posts);
            const title = (post.title || "").trim();
            const body = (post.body || "").trim();
            const text = body ? `标题：${title}\n\n正文：${body}` : `标题：${title}`;
            return { author: (post.author || "").trim(), text, url: (post.url || "").trim() };
        }

        function pickDistractor(correctAuthor) {
            const sampleSize = Math.min(20, posts.length);
            const shuffled = [...posts].sort(() => Math.random() - 0.5);
            const sampled = shuffled.slice(0, sampleSize);
            const pool = [...new Set(
                sampled
                    .map((item) => (item.author || "").trim())
                    .filter((name) => name && name !== correctAuthor)
            )];
            if (pool.length > 0) {
                return getRandomItem(pool);
            }
            const fallback = posts
                .map((item) => (item.author || "").trim())
                .filter((name) => name && name !== correctAuthor);
            return fallback.length > 0 ? getRandomItem(fallback) : "未知作者";
        }

        function applyTextStyle(text) {
            mainText.className = "cursor font-bold leading-relaxed text-center whitespace-pre-wrap break-words max-w-full my-auto";

            if (text.length <= 10) {
                mainText.classList.add('text-4xl', 'md:text-6xl');
            } else if (text.length <= 30) {
                mainText.classList.add('text-2xl', 'md:text-4xl');
            } else if (text.length <= 100) {
                mainText.classList.add('text-1xl', 'md:text-2xl');
            } else {
                mainText.classList.add('text-lg', 'md:text-1xl', 'text-left');
                mainText.classList.remove('text-center');
            }
        }

        function startTyping(text) {
            clearTimeouts();
            isTyping = true;
            mainText.innerHTML = "";
            let i = 0;
            const speed = text.length > 50 ? 10 : 50;

            function type() {
                if (i < text.length) {
                    mainText.innerHTML += text.charAt(i) === '\n' ? '<br>' : text.charAt(i);
                    textWrapper.scrollTop = textWrapper.scrollHeight;
                    i++;
                    timeoutIds.push(setTimeout(type, speed + Math.random() * 20));
                } else {
                    isTyping = false;
                }
            }
            type();
        }

        function finishTyping() {
            if (!isTyping) return;
            clearTimeouts();
            mainText.innerHTML = mainText.dataset.fullText.replace(/\n/g, '<br>');
            isTyping = false;
            setTimeout(() => {
                textWrapper.scrollTop = textWrapper.scrollHeight;
            }, 50);
        }

        function startRound() {
            if (!postsReady) {
                mainText.innerText = "数据加载中...";
                resultText.textContent = "";
                showNextButton(false);
                setChoicesEnabled(false);
                return;
            }

            isAnswered = false;
            resultText.textContent = "";
            pausedResultHtml = "";
            showNextButton(false);
            setChoicesEnabled(true);

            displayContainer.classList.add('glitch-active');
            setTimeout(() => displayContainer.classList.remove('glitch-active'), 200);

            const { author, text, url } = pickQuestion();
            currentSource = author;
            mainText.dataset.currentUrl = url || "";
            mainText.dataset.fullText = text;
            applyTextStyle(text);
            startTyping(text);

            const distractor = pickDistractor(author);
            const options = Math.random() < 0.5 ? [author, distractor] : [distractor, author];
            choiceLinbai.textContent = options[0];
            choiceNanoi.textContent = options[1];
            startScoreTimer();
        }

        function handleAnswer(choice) {
            if (isAnswered) return;
            finishTyping();
            isAnswered = true;
            setChoicesEnabled(false);

            const correct = choice === currentSource;
            const answerLabel = currentSource || "未知作者";
            const currentUrl = mainText.dataset.currentUrl || "";
            if (correct) {
                correctCount += 1;
                score += 10;
            } else {
                wrongCount += 1;
                score -= 10;
            }
            updateStats();
            updateScore();
            const baseText = correct ? "回答正确" : `回答错误 正确答案：${answerLabel}`;
            resultText.innerHTML = currentUrl
                ? `${baseText}<br><a href="${currentUrl}" target="_blank" class="underline">查看帖子</a>`
                : baseText;
            showNextButton(true);
            stopScoreTimer();
        }

        choiceLinbai.addEventListener('click', () => handleAnswer(choiceLinbai.textContent));
        choiceNanoi.addEventListener('click', () => handleAnswer(choiceNanoi.textContent));
        nextQuestion.addEventListener('click', () => {
            if (isPaused) return;
            startRound();
        });
        pauseBtn.addEventListener('click', () => {
            isPaused = !isPaused;
            pauseBtn.textContent = isPaused ? "▶" : "⏸";
            if (isPaused) {
                pausedResultHtml = resultText.innerHTML;
                resultText.textContent = "暂停";
                setChoicesEnabled(false);
                stopScoreTimer();
                nextQuestion.disabled = true;
                nextQuestion.classList.add('opacity-40', 'cursor-not-allowed');
            } else {
                resultText.innerHTML = pausedResultHtml || "";
                if (!isAnswered && postsReady) {
                    setChoicesEnabled(true);
                    startScoreTimer();
                }
                nextQuestion.disabled = false;
                nextQuestion.classList.remove('opacity-40', 'cursor-not-allowed');
            }
        });
        restartBtn.addEventListener('click', () => {
            score = 0;
            maxScore = 0;
            correctCount = 0;
            wrongCount = 0;
            updateScore();
            updateStats();
            isPaused = false;
            pauseBtn.textContent = "⏸";
            startRound();
        });

        async function loadPosts() {
            try {
                const res = await fetch('hot_posts.json', { cache: 'no-store' });
                if (!res.ok) throw new Error('load failed');
                posts = await res.json();
                posts = posts.filter((item) => item && (item.title || item.body) && item.author);
                postsReady = posts.length > 0;
            } catch (err) {
                postsReady = false;
                mainText.innerText = "加载失败 请用本地服务器打开";
                resultText.textContent = "";
                setChoicesEnabled(false);
                showNextButton(false);
            }
        }

        scoreHelpBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            scoreRulesTooltip.classList.toggle('hidden');
        });
        document.addEventListener('click', () => scoreRulesTooltip.classList.add('hidden'));
        scoreRulesTooltip.addEventListener('click', (e) => e.stopPropagation());

        async function refreshLeaderboardList() {
            const api = window.firestoreApi;
            if (!api || !api.getLeaderboard) {
                leaderboardList.innerHTML = '<div class="opacity-60 text-center py-4">未配置 Firebase，请在 index.html 中填写 firebaseConfig。</div>';
                return;
            }
            try {
                const entries = await api.getLeaderboard();
                if (!entries.length) {
                    leaderboardList.innerHTML = '<div class="opacity-60 text-center py-4">暂无记录，快来上传你的最高分吧！</div>';
                    return;
                }
                const myEntries = getMyLeaderboardEntries();
                leaderboardList.innerHTML = entries.map((e, i) => {
                    const rate = e.correctRate != null ? Number(e.correctRate) : null;
                    const cc = e.correctCount != null ? Number(e.correctCount) : null;
                    const timeStr = e.createdAt && e.createdAt.toDate ? e.createdAt.toDate().toLocaleString('zh-CN') : '';
                    const isMine = myEntries[e.id];
                    const delBtn = isMine ? `<button type="button" class="leaderboard-del-btn cyber-btn px-2 py-0.5 text-xs rounded mt-1" data-doc-id="${escapeHtml(e.id)}">删除</button>` : '';
                    return `<div class="border-b border-green-900/50 py-2">
                        <div class="flex justify-between items-center">
                            <span class="opacity-80">${i + 1}. ${escapeHtml(e.nickname || '匿名')}</span>
                            <span class="font-bold">${Number(e.score)}</span>
                        </div>
                        <div class="text-xs opacity-60 mt-0.5">正确率 ${rate != null ? rate + '%' : '-'} · 正答 ${cc != null ? cc : '-'}${timeStr ? ' · ' + timeStr : ''}</div>
                        ${delBtn}
                    </div>`;
                }).join('');
                leaderboardList.querySelectorAll('.leaderboard-del-btn').forEach(btn => {
                    btn.addEventListener('click', onLeaderboardDelete);
                });
            } catch (err) {
                leaderboardList.innerHTML = '<div class="opacity-60 text-center py-4 text-red-400">加载失败：' + escapeHtml(String(err.message)) + '</div>';
            }
        }
        function escapeHtml(s) {
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        const LEADERBOARD_MY_ENTRIES_KEY = 'leaderboardMyEntries';
        const LEADERBOARD_LAST_NAME_KEY = 'leaderboardLastName';
        function getLastLeaderboardName() {
            try {
                return localStorage.getItem(LEADERBOARD_LAST_NAME_KEY) || '';
            } catch (_) { return ''; }
        }
        function saveLastLeaderboardName(name) {
            try {
                if (name && name.trim()) localStorage.setItem(LEADERBOARD_LAST_NAME_KEY, name.trim().slice(0, 20));
            } catch (_) {}
        }
        function updateUserNameDisplay() {
            const name = getLastLeaderboardName();
            if (userNameDisplay) userNameDisplay.textContent = name || '???';
        }
        function getMyLeaderboardEntries() {
            try {
                const raw = localStorage.getItem(LEADERBOARD_MY_ENTRIES_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch (_) { return {}; }
        }
        function saveMyLeaderboardEntry(docId, deleteToken) {
            const entries = getMyLeaderboardEntries();
            entries[docId] = deleteToken;
            localStorage.setItem(LEADERBOARD_MY_ENTRIES_KEY, JSON.stringify(entries));
        }
        function removeMyLeaderboardEntry(docId) {
            const entries = getMyLeaderboardEntries();
            delete entries[docId];
            localStorage.setItem(LEADERBOARD_MY_ENTRIES_KEY, JSON.stringify(entries));
        }

        async function onLeaderboardDelete(ev) {
            const btn = ev.target;
            const docId = btn.dataset.docId;
            if (!docId) return;
            const myEntries = getMyLeaderboardEntries();
            const token = myEntries[docId];
            if (!token) return;
            const api = window.firestoreApi;
            if (!api || !api.deleteEntry) return;
            try {
                await api.deleteEntry(docId, token);
                removeMyLeaderboardEntry(docId);
                await refreshLeaderboardList();
            } catch (err) {
                alert('删除失败：' + err.message);
            }
        }

        leaderboardBtn.addEventListener('click', () => {
            leaderboardModal.classList.remove('hidden');
            if (leaderboardNameInput) leaderboardNameInput.value = getLastLeaderboardName();
            refreshLeaderboardList();
        });
        clearHistoryBtn.addEventListener('click', () => {
            if (!confirm('确定清除历史最高分记录？已上传到排行榜的记录和删除权限不会受影响。')) return;
            historyMaxScore = 0;
            historyMaxCorrectCount = 0;
            historyMaxWrongCount = 0;
            localStorage.removeItem('historyMaxScore');
            localStorage.removeItem('historyMaxCorrectCount');
            localStorage.removeItem('historyMaxWrongCount');
            historyMaxScoreVal.textContent = '0';
        });
        leaderboardClose.addEventListener('click', () => leaderboardModal.classList.add('hidden'));
        leaderboardModal.addEventListener('click', (e) => { if (e.target === leaderboardModal) leaderboardModal.classList.add('hidden'); });

        async function doSubmitScore(useHistory) {
            const api = window.firestoreApi;
            if (!api || !api.submitScore) {
                alert('未配置 Firebase，无法上传分数。');
                return;
            }
            const nickname = (leaderboardNameInput && leaderboardNameInput.value.trim()) ? leaderboardNameInput.value.trim().slice(0, 20) : '匿名';
            let sc, correctRate, correctCountVal;
            if (useHistory) {
                const total = historyMaxCorrectCount + historyMaxWrongCount;
                correctRate = total > 0 ? Math.round((historyMaxCorrectCount / total) * 100) : 0;
                sc = historyMaxScore;
                correctCountVal = historyMaxCorrectCount;
            } else {
                const total = correctCount + wrongCount;
                correctRate = total > 0 ? Math.round((correctCount / total) * 100) : 0;
                sc = maxScore;
                correctCountVal = correctCount;
            }
            if (sc <= 0) {
                alert(useHistory ? '历史最高分为 0，无法上传。' : '当前回合暂无分数，请先玩一局。');
                return;
            }
            try {
                const result = await api.submitScore(nickname, sc, correctRate, correctCountVal);
                if (result && result.alreadyStored) {
                    alert('上传被阻止：已存在完全相同的记录（总分、正确率、正答数均一致），请勿重复上传。');
                    return;
                }
                if (nickname && nickname !== '匿名') {
                    saveLastLeaderboardName(nickname);
                    updateUserNameDisplay();
                }
                if (result && result.docId && result.deleteToken) {
                    saveMyLeaderboardEntry(result.docId, result.deleteToken);
                }
                await refreshLeaderboardList();
            } catch (err) {
                alert('上传失败：' + err.message);
            }
        }
        leaderboardSubmit.addEventListener('click', () => doSubmitScore(true));
        leaderboardSubmitCurrent.addEventListener('click', () => doSubmitScore(false));

        startGameBtn.addEventListener('click', () => {
            startGameBtn.classList.add('hidden');
            choiceLinbai.classList.remove('hidden');
            choiceNanoi.classList.remove('hidden');
            restartBtn.disabled = false;
            restartBtn.classList.remove('opacity-40', 'cursor-not-allowed');
            pauseBtn.disabled = false;
            pauseBtn.classList.remove('opacity-40', 'cursor-not-allowed');
            startRound();
        });

        function showStartScreen() {
            mainText.innerText = "点击下方按钮开始游戏";
            resultText.textContent = "";
            startGameBtn.classList.remove('hidden');
            choiceLinbai.classList.add('hidden');
            choiceNanoi.classList.add('hidden');
            nextQuestion.classList.add('hidden');
            setChoicesEnabled(false);
            restartBtn.disabled = true;
            restartBtn.classList.add('opacity-40', 'cursor-not-allowed');
            pauseBtn.disabled = true;
            pauseBtn.classList.add('opacity-40', 'cursor-not-allowed');
        }

        // 初始化
        setTimeout(() => {
            mainText.innerText = "READY.";
        }, 400);
        setTimeout(async () => {
            const savedMax = Number(localStorage.getItem('historyMaxScore') || 0);
            historyMaxScore = Number.isFinite(savedMax) ? savedMax : 0;
            historyMaxCorrectCount = Math.max(0, Number(localStorage.getItem('historyMaxCorrectCount') || 0));
            historyMaxWrongCount = Math.max(0, Number(localStorage.getItem('historyMaxWrongCount') || 0));
            historyMaxScoreVal.textContent = String(historyMaxScore);
            updateUserNameDisplay();
            if (leaderboardNameInput) leaderboardNameInput.value = getLastLeaderboardName();
            await loadPosts();
            if (postsReady) {
                showStartScreen();
            } else {
                mainText.innerText = "加载失败 请用本地服务器打开";
            }
            updateScore();
        }, 900);

    </script>
</body>
</html>